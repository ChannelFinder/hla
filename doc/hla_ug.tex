\documentclass[letterpaper,showtrims]{memoir}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{verbdef}
\usepackage{xspace}
\usepackage{fancyvrb}
\usepackage{hyperref}
\usepackage{makeidx}
\makeindex

\makepagestyle{index}
\makeheadrule{index}{\textwidth}{\normalrulethickness}
\makeevenhead{index}{\rightmark}{}{\leftmark}
\makeoddhead{index}{\rightmark}{}{\leftmark}
\makeevenfoot{index}{\thepage}{}{}
\makeoddfoot{index}{}{}{\thepage}

\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\var}[1]{\texttt{#1}}
\newcommand{\strong}[1]{{\bfseries #1}}

% Prints the month name (e.g., January) and the year (e.g., 2008)
\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}

\newcommand{\smallcaps}[1]{\smallcapsspacing{\MakeTextLowercase{#1}}}

\newcommand{\TODO}{\textcolor{red}{\bf TODO!}\xspace}
\newcommand{\ie}{\textit{i.\hairsp{}e.}\xspace}
\newcommand{\eg}{\textit{e.\hairsp{}g.}\xspace}
\newcommand{\na}{\quad--}% used in tables for N/A cells

\title{High Level Applications (User Guide)}
% subtitle Tools for Accelerator Commissioning and Physics
\author{Guobao Shen, shengb@bnl.gov, Lingyun Yang lyyang@bnl.gov}
\chapterstyle{ell}

\begin{document}
\begin{titlingpage}
{\begingroup% Story of Writing
\raggedleft
\vspace*{\baselineskip}
{\Huge\itshape User Guide} \\
\vspace*{\baselineskip}{\Huge\itshape of High Level Applications}\\[\baselineskip]
{\large\itshape NSLS-II commissioing tools}\\[0.2\textheight]
{\Large Guobao Shen\\Lingyun Yang}\par
\vfill
\flushleft
{\sffamily
  Schedule:\hfill
\begin{itemize}
\item 12/01/2011--02/29/2012, LINAC front end
\item 03/30/2012--07/28/2012, LINAC
\item 05/29/2012--06/28/2012, LBTL in LINAC
\item 07/28/2012--08/27/2012, LBTL
\item 08/27/2012--12/25/2012, Booster
\item 12/15/2012--01/14/2013, BSTL in Booster tunnel
\item 01/14/2013--01/24/2013, BSTL
\item 01/24/2013--09/21/2013, Storage Ring Commissioning Part 1
\item 09/21/2013--11/20/2013, ID installation
\item 11/20/2013--02/18/2014, Storage Ring Commissioning Part 2
\end{itemize}
}
\vspace*{5ex}
%{\Large \plogo{} \sffamily The Publisher}
{\small\scshape September 24, 2010}
\vspace*{\baselineskip}
\endgroup}
%\maketitle
\end{titlingpage}
%\titleRB
%\clearpage


\newpage
%\begin{fullwidth}
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}
Copyright \copyright\ %\the\year\ \thanklessauthor

\par\textit{First printing, \monthyear}
%\end{fullwidth}

This manual is for tools for accelerator commissioning and physics. It
is original for NSLS-II (National Synchrotron Light Source II)
project, which is under construction at Brookhaven National
Laboratory. 

Copyright @copyright{} 2010 The NSLS-II Project.


\newpage
\setcounter{tocdepth}{3}
\tableofcontents


\chapter{Introduction}


This HLA package is meant to be a set of APIs and applications for
accelerator physics study and commissioning. The document is compiled
based on the requirements from the following documents:
\begin{itemize}
\item 2008, NSLS-II: Model Based Control - A Use Case Approach~\cite{bengtsson_2008_nsls-ii}
\item 2009, Assumptions on NSLS-II Accelerator Commissioning~\cite{willeke_2009_assumptions}
\item 2010, The Path to Accelerator Commissioning~\cite{willeke_2010_path}
\item 2010, NSLS-II Storage Ring Commissioning~\cite{krinsky_2010_nsls-ii}
\end{itemize}
The applications for beam commissioning will be based on these APIs
listed in this note. The details of each API can be found in the
reference manual distributed with the source code.

\section{Schedule for Beam Commissioning}

\vspace{5ex}
\begin{itemize}
\item 12/01/2011--02/29/2012, LINAC front end commissioning
\item 03/30/2012--07/28/2012, LINAC commissioning
\item 05/29/2012--06/28/2012, LBTL in LINAC commissioning
\item 07/28/2012--08/27/2012, LBTL commissioning
\item 08/27/2012--12/25/2012, Booster commissioning
\item 12/15/2012--01/14/2013, BSTL in booster tunnel
\item 01/14/2013--01/24/2013, BSTL
\item 01/24/2013--09/21/2013, Storage Ring Commissioning Part 1
\item 09/21/2013--11/20/2013, ID installation
\item 11/20/2013--02/18/2014, Storage Ring Commissioning Part 2
\end{itemize}

\section{Overview of Control Scripts and Applications}

The high level control software is developed for the beam commissioning
and accelerator physics study. It is designed for monitoring, control and modeling
the electron beam and accelerators.

A set of existing tools such as MATLAB Middle Layer~(MML) will be
installed in the control room. However, more new tools need to be
developed especially for the first turn beam monitoring and manipulations.

The new developement will be based on Python language environment,
integrated with libraries for numerical analysis, data input/output, image
processing, network, visualization, statistics, EPICS channel access. This
environment will have both interactive control terminal and batch~(script)
processing mode. High level applications and application programming
interface~(API) will be developed to make beam manipulation and hardware
control more easier and straight forward for physicists and operators.

The new Python based package will have certain overlap with MML, and will
have better integration with the global database, where all related
information are stored: from magnet bentchmark data to user profile.

This work is done by both controls group and accelerator physics group.

\section{HLA Architecture}

The high level applications developed by accelerator physicists should
be able to achieve their goals by focusing on algorithms while being
released from tedious data acquisition and manipulation issues. This
is the design strategy for the software architecture. With a clean and
carefully designed interface, collaborators, who have different areas
of expertise such as GUI design, numerical analysis, accelerator
physics, data acquisition, hardware control, and so on, can work
together effectively and productively.

The system architecture is shown as below:

\begin{figure}
  \includegraphics[width=\textwidth]{hla_arch}
  \caption{A client/cerver based architecture for HLA}
\end{figure}

It adopts a client/server model, and consists of various servers for data
acquisition, analysis, management and communication. Based on this
structure, physics applications can be developed to satisfy the
requirements of both day-1 beam commissioning, future beam study, and
daily operation.  Briefly, the system consists of
\begin{itemize}
\item data source layer, which can be low level hardware control system,
  or a relational database;
\item a service layer, which provides services to gather data from the
  data source layer, and perform data manipulations such as constructing
  an orbit using BPM data;
\item a presentation layer, which present machine status to operators, and
  provides an interface for machine control
\end{itemize}

The server part talks directly with hardware using EPICS PV. It is an area
controls group focus on. All the data on ``data bus'' have a meaningful
name instead of long abstract channel name. e.g. the setpoint of
horizontal orbit corrector in cell 1 girder 3 is presented to accelerator
physicists as \code{CH1[0]} instead of \code{``SR:C01-MG:G03A.SP''}. This
makes them to write high level control scripts easier. The client API
which encapsulate low level control details are listed in
~\cite{shen_hla_apis}. They usually contains physics logic or accelerator
dependent quantities inside. e.g. \code{getChannelVariance},
\code{measureChromaticity}.



\chapter{Software Requirement}

This chapter describes software requirement for NSLS-II
commissioning. This list is mainly from \cite{willeke_2009_assumptions}
and \cite{krinsky_2010_nsls-ii}, plus some personal experiences.

The items marked with (*) are closely related to HLA (High Level
Applications) development, where we need algorithms instead of straight
display. A more detailed list specfically for accelerator physics
related functions are in next chapter (\ref{chap:aptoolkit})


\section{General Operation}

\begin{itemize}
\item Overall status page (warning when read/set are different too much ?)
\item Status, Alarm and warning monitor
\item Permit system monitor and control
\item Data logger and data display
\item Electronic logbook
\end{itemize}

\section{Operations Software}

\begin{itemize}
\item Accelerator parameter store/restore (*)
      \begin{enumerate}
      \item manage, editing capability for stored accelerator status.
      \item smoothly ramp from one stage to another.
      \item compare two stages, online and saved data, two data file.
      \end{enumerate}
\item Injection Control
\item Power supply control
\item RF control
\item Fast orbit feedback control
\item Front-end monitoring and control
\item Machine protection system display and control
\item Magnet temperature interlock display and control
\item Scraper and movable mask operations
\end{itemize}


\section{Major Subsystem Control}

\begin{itemize}
\item Power supply page which lists for all PS:
      \begin{enumerate}
      \item setting or waveform, read back
      \item difference between DCCTs, status
      \item recent history.
      \end{enumerate}
\item RF page with all relevant settings, read back, status, parameters
\item Vacuum display and control. ``Water flow'' or 3D plot of vacuum status along the ring with time line info.
\item Cryogenics system display and control
\item Pulsed magnet systems monitor and control
\end{itemize}


\section{Beam Diagnostics}

\begin{itemize}
\item Beam orbit page with closed orbit, turn by turn, single turn, status information, difference (referecne orbit display) (*)
\item Beam current history and lifetime display (*)
\item Bunch intensity display and history display/analysis (*)
\item Beam emittance display (*)
\item Injection element display and control page (*)
\item Timing system display and control 
\item Synchronization system display and control
\item Tune display and control (*)
\item Temperature monitoring display
\item Bunch length and profile if it is available (*)
\item Measure BPM linearity
\end{itemize}

\section{Safety Systems}

\begin{itemize}
\item Personal protection system status display
\item Equipment protection status display and control
\item Beam containment status display and control
\item Top-off status monitor
\end{itemize}

\section{Utility Control}

\begin{itemize}
\item Tunnel air temperature and humidity monitor
\item Mechanical utilities status and controls
\item Electrical utilities status and controls
\item Equipment enclosure monitor
\item Water colling system display
\item Controls network monitor
\end{itemize}


\section{Beam Status Diagnostics}

A set of API should be provided to allow physicists to fetch data from
circular buffer of related sub-system, especially diagnostic
instrument, and RF. Detailed requirement can be found in
@cite{Circular Buffer Diagnostic} (@pxref{Reference}). 



@c -------------------------------------------------------------


\chapter{High Level Applications}

The HLA and Controls are divided into three layers: HLA applictions and
scripts, client APIs and server API~(\cite{shen_hla_apis}).  The users
(accelerator physicists, operators and beamline scientists) will normally
access the first two forms: use applications/scripts by mouse clicks, and
the APIs in an interactive command line.


Applications include:
\begin{itemize}
\item Overall status of all subsystems: magnet, vacuum, RF, temparature
\item Orbit display and correction.
\item Linear optics reconstruct, i.e. LOCO
\item Beam based alignment.
\end{itemize}

APIs are defined in \cite{shen_hla_apis}, and are used by HLA
applications. They include data acquisition, processing and storage, and
can be combined for different purpose. The APIs are in Python language,
and can be used in both interactive environment or scripts. Necessary
packages including linear algebra, frequency analysis, statistics, data
IO, database, network, regular expression and visualization will be
provided. See \cite{Python} (\url{http://www.python.org}), \cite{SciPy}
(\url{http://www.scipy.org}), \cite{NumPy}
(\url{http://numpy.scipy.org/}, \cite{iPython}
(\url{http://ipython.scipy.org/}), \cite{Matplotlib}
(\url{http://matplotlib.sourceforge.net/}).


\section{HLA Applications}

The HLA applications are those have a stable algorithm and data
flow. Each is in a standalone form.


\subsection{Machine Status}

The applications will provide overall status of the whole machine, and
give warnings when any abnormal beam behaviour is detected, for example
a readback differs from setting point larger than its threshhold. The
status includes beam information, and hardware status including magnet
and its power supply, vacuum, RF, and so on.

These part can be done in EDM or CSS. No heavy data manipulation or
physics logics.

\begin{itemize}
\item Tunes
      \begin{itemize}%[\bfseries\textenddash]
      \item horizontal/vertical tune number, >1Hz update
      \item optional: FFT of turn by turn BPM data, choice of any live BPM.
      \item optional: 2D tune footprint with resonance lines
      \end{itemize}
\item Magnets, tables of data. SP/RB of main magnets: quadrupoles, sextupoles, correctors.
\item Vacuum status in plots and tables.
      \begin{itemize}%[\bfseries\textenddash]
      \item Pressure vs index.
      \item optional: Pressure vs pump location.
      \end{itemize}
\item RF status
      \begin{itemize}%[\bfseries\textenddash]
      \item optional: RF feedback status which detects orbit drift vs RF frequency.
      \end{itemize}
\item Feedback status
\item beam current, size(rms, center, image)
\end{itemize}


\subsection{Orbit Display and Correction}

This application displays and controls electron orbit.
  
\begin{itemize}
\item Static orbit display
      \begin{itemize}%[\bfseries\textenddash]
      \item Plot static orbit. (with magnet layout)
      \item show golden orbit (or reference orbit)
      \item absolute orbit offset and orbit offset with respect to golden orbit
      \item plot orbit change from now on.
      \item orbit statistics. stability, especially drift and variation
      \end{itemize}
\item Static orbit control
      \begin{itemize}%[\bfseries\textenddash]
      \item correct static orbit with selected correctors and BPMs
      \item select BPMs for orbit correction.
      \item select correctors for orbit correction
      \item import/export orbit response matrix
      \item edit orbit offset. (e.g. to create local bump)
      \end{itemize}
\item Orbit feedback status
\item Turn by turn BPM
      \begin{itemize}%[\bfseries\textenddash]
      \item reading vistualization when available/enabled
      \item get/plot turn-by-turn BPM signal, including orbit and sub/diff
      \item BPM buttons readout.
      \item plot single shot orbit
      \end{itemize}
\end{itemize}

Interplay with feedback system when creating local bump: update the
reference orbit to feedback ? or share same orbit difference from a
dedicated IOC ? the feedback should check golden orbit at 10-50Hz rate
if real-time orbit difference is not available to it.


\subsection{Beam Based Alignment (BBA)}

BBA use a list of correctors, BPMs and nearby quadrupoles, to steer the
beam through center of these quadrupoles. The input is a list of
corrector-BPM-quadrupole triplets.  The BPMs in corrector-BPM-quadrupole
triplet is a subset of live BPM.  This needs to get the golden orbit,
set the golden orbit, line fitting, step the quadrupole, step the
corrector (this can be a ``macro step'', e.g. 10 times than normal step
size). Many raw data needs to be saved in certain format (\strong{DISCUSSION}:
plain text, C binary, HDF5, SDDS, Matlab ?).

We would prefer to have all data saved, corrector settings/readings, BPM
readings and Quadrupole settings/readings.

The measurement and analysis can be separated conceptually, which makes the
post processing more easier, i.e. we can analyze any historical data. 

It should work on separate set of quadrupoles, and combine data with previous measurement.

\subsection{Linear Lattice Fitting (LOCO)}

\begin{itemize}%[\bfseries\textenddash]
\item analyze quadrupole gradient error.
\item analyze BPM gain error.
\end{itemize}

It requires:
\begin{enumerate}
\item Designed orbit response matrix (ROM)
\item change specified correctors 
\item get closed orbit change at specified BPM
\end{enumerate}

This application needs mathematical package to do minimization and
singular value decomposition (SVD). It also requires simulator for
fitting.

\subsection{Measure TWISS Parameters}

\begin{itemize}%[\bfseries\textenddash]
\item measure beta functions
\item measure dispersion
\item measure chromaticity
\item measure coupling
\item measure coupling response matrix
\end{itemize}

\subsection{Smooth Ramping}

\begin{itemize}%[\bfseries\textenddash]
\item list channels we are interested.
\item ramp whole group at certain rate.
\end{itemize}
It requires:
\begin{enumerate}
\item searching for channels (regular expression, wild-card)
\item save state/read stage.
\end{enumerate}
The control group may provide ramping for whole storage ring, here this
application can ramp specified channels between two states.

\subsection{History Analyzer}

\begin{itemize}%[\bfseries\textenddash]
\item view archive data in certain time frame.
\item link to logbook to view reasons for shutdown, current drop (?)
\item simple statistic for the data: average, variance, maximum, minimum.
\item print, save figures.
\end{itemize}


\subsection{Insertion Device Related (Matching)}

\begin{itemize}%[\bfseries\textenddash]
\item get/correct closed orbit distortion
\item get/correct phase distortion
\item get/correct coupling distortion
\end{itemize}

\subsection{Simulator}

This is usefull for LOCO lattice fitting. If we decide to have it, an
independent set of APIs could be a choice. This is easier if the
simulator has a simple form instead of complete mimic of a real machine.

\subsection{Misc}

\begin{itemize} %[\bfseries\textenddash]
\item Current dependency of BPM and orbit feedback. Choi proposed to
  measure the current dependency of BPM readings and compensate that for
  orbit feedback.
\item PBPM matching. Choi proposed to read both BPM and PBPM, and use BPM
  to predict the PBPM values, since he thought PBPM reading can be
  affected by local status including Front End.
\item get groud motion and chamber motion if there are available readings
  (Choi proposed)
\item monitor loss. Get loss monitor readings from beam containment system
  (beam loss monitor).
\item Identify MPS (magnet power sypply) ripples.
\item Magenet reproducibility. Choi proposed that test magnet setting
  reproducibility by setting same values for several times and check the
  variance/average of its result, which could be orbit shift, tune change,
  etc. Check and confirm that the hystereses of correctors do not affect
  the orbit stability. Also identify the correctors with excessive
  hystereses if there are any.
\end{itemize}
%@c \end{enumerate}

One interactive \code{Python} environment is also provided for
interactive control of the storage ring. In this interactive
environment, a set of APIs are provided to make physicists who has no
knowledge of EPICS or low level channel access be able to do many
measurements and diagnostics.

This interactive mode can also run as batch mode, which makes the
prototyping of new HLA and algorithms more easier.

The plotting features are only in interactive environment and GUI
applications. Scripts and save pictures in \code{png}, \code{jpeg},
\code{pdf} and \code{eps} format.


\begin{itemize}
\item BBA and LOCO are HLA applications. Turn by turn beam orbit
  measurement and analysis can be a HLA script.
\item Client APIs are a group of physics logics, e.g. \code{measOrbitRm},
  \code{measChromaticity}, \code{getGoldenOrbit}, ...
\item Server APIs are called by client APIs across the network, and will
  not be seen by HLA applications or scripts. The server APIs have two
  major functions:
  \begin{itemize}%[\bfseries\textenddash]
  \item manage the accelerator magnets/lattice information, e.g. logic
    group of a magnet, whether it is used by BBA or LOCO or orbit
    measurement etc. The basic information is contained in a XML file or a
    database in the following sections, (the implementation may not be a
    XML file, but a Database). lattice layout. (optional: nearby vacuum
    and temperator sensor information, power supply name and location)
  \item control the magnets via a control server, this server will call
    low level APIs to do PV readings and settings.
  \end{itemize}
\end{itemize}


\chapter{Accelerator Physics Toolkit}

By toolkit, we mean a short script based on CAPIs. Not like HLAs, they
have small set of functions, but easy to understand and modify. For
example we put a small script \code{probeBpmStability} into this category,
since it is mainly a function call of \code{getBpmVariance} plus checking
against certain criterial.

Since the CAPIs (client APIs) are from requirement analysis of NSLS-II
commissioning plan, we can describe those accelerator physics tasks and
the related APIs (both client and server).

\section{Requirement}

We have compiled a set of requirements for high level control software,
and design the APIs as a common library. The high level applications will
use these APIs to fulfil comissioning, operations and physics studies. We
need more input from operation group to make these tools more
operator-friendly.

\subsection{Physics Tasks for Storage Ring}

In NSLS-II storage ring commissioning plan~\cite{willeke_2009_assumptions,
  krinsky_2010_nsls-ii}, we have defined the requirement of control
software. Here we only summarize the functions needed, but neglect the
order of using them in the commissioning.

\begin{itemize}
\item Hardware/Control checking and testing
  \begin{itemize}
  \item BPM testing programs: stability, polarity, current dependency, resolution.
  \item Orbit corrector test, polarity, strength.
  \item Set/Read any main magnet. Converting between machine unit and physics unit.
  \item Ramping from one magnet setting to another.
  \item Monitoring stability of any readings and online data: magnet
    readback, orbit, temperature, vacuum.
  \item Magnetic field measurement and modeling, determine calibration
  \item Verify named devices in control system, control proper hardware
  \item Check polarity of all magnets.
  \item Complete survey of magnetic elements
  \item Test diagnostic equipment without beam
  \end{itemize}
\item BTS transport line, obtain good transmission through septum and good
  transverse phase space match, set timing of pulsed magnets.
\item Linear and nonlinear lattice modeling
  \begin{itemize}%[\bfseries\textenddash]
  \item First turn beam steering. Turn by turn BPM data visulization and analysis
  \item Obtain first turn in storage ring using single kicker
    \begin{itemize}%[\bfseries\textenddash]
    \item Center beam in single downstream single kicker
    \item Adjust kicker strength to place beam on design orbit.
    \item Use single turn BPMs to steer beam trajectory around ring and
      estimate linear optics and tune.
    \item Use flag to obtain beam size information at injection point and
      after one turn.
    \end{itemize}
  \item Single shot beam position, turn by turn BPM reading and orbit
    analysis.
  \item Measure the orbit response matrix, with flexible number of BPMs
    and correctors.
  \item Static orbit correction with flexible list of correctors and BPMs.
  \item Local closed orbit bump (one page, particularly for injection).
  \item Measure and adjust tune. (tune scan ?)
  \item Measure and correct the chromaticity (linear and nonlinear). 
  \item Measure beam optics including phase advance, beta functions, dispersion.
  \item Dispersion measurement and correction, optimal set of quads
  \item Beam based alignment (quadrupole and BPM).
  \item Beam based alignment of sextupoles.
  \item Linear optics fitting and optimization with LOCO.
  \item Develop lattice model using measured fields, linear/nonlinear optics.
  \item Reduce beta beat
  \item Correct coupling using skew quadrupoles, local and global.
  \item Analysis on nonlinear dynamics.
  \item Use Pinger to measure tune shift with amplitude, dynamic aperture
    and characterize sextupole distribution
  \item Wakefield modeling and tracking studies, develop model for
    impedance and wakefields, caculation and measurement, estimate
    instability thresholds, simulate bunch-by-bunch feedback with
    realistic bunches and wakefields.
  \item Characterize ring impedance using beam.
  \end{itemize}
\item Logging all necessary machine settings data, and retrive the
  historical data for analysis.
\item Look for magnet errors that may have been missed in testing.
\item Commission loss control minitoring system
\item Use visible synchrotron light monitor to study transverse beam profile and disturbance due to kickers. \code{getBeamProfile}
\item Study lifetime versus vacuum pressure, vertical beam size, scraper, dynamic aperture.
\item Test fast orbit feedback system.
\item Commission transverse bunch-by-bunch feedback
\item Measure variation of coherent tune with current
\item Study increasing chromaticity from +2/+2 to +5/+5
\item Commission undulator gap control in control room
\item Establish and save reference orbit (low current 5mA)
\item Calibration/Testing of Equipment Protection Interlock System
  \begin{itemize}%[\bfseries\textenddash]
  \item Center photon beam in exit slot
  \item Verify gap open/close status is properly reported to interlock system
  \item Measure interlock BPM offset and scale factors.
  \item Adjust the hardware trip points on the local logic chassis
  \item Verify beam is dumped at the specified position offsets.
  \item Set the values in the interlock test file
  \item Set the values in the micro
  \item Verify the proper operation of the interlock test
  \end{itemize}
\item ID
  \begin{itemize}%[\bfseries\textenddash]
  \item When necessary compensate the linear optics for ID
  \item Observe orbit and tune shift vs gap
  \item Measure lifetime vs gap
  \item Observe beam stability vs current
  \item Measure change in impedance due to ID chamber
  \item Prepare look-up tables for feed forward orbit correction coils.
  \item Measure effect on tune shift with amplitude, chromaticity, and emittance coupling.
  \item Measure impedance vs gap for IVUs
  \item Commission undulator gap control for users
  \item Measure flux and brightness
  \end{itemize}
\item Top-off Injection
  \begin{itemize}%[\bfseries\textenddash] 
  \item Check position of apertures in ring and beamline
  \item Test interlocks
  \item Characterize injection transient on transverse orbit, contribution from septum and kickers.
  \item Test transverse feedback with injection transient
  \end{itemize}
\item Concerns: accuracy of magnet calibration-two types of dipoles, magnetic field quality (IRMIS data).
\end{itemize}


\subsection{Physics Tasks for Injector}

Software routines needed for the injector commissioning and operation are
listed in this section. Some of these routines will be delivered by linac
and booster vendors, others have to be developed by ourselves.

\begin{itemize}

\item Linac
\begin{itemize}
\item Diagnostics calibration
\item Routines for optimization of linac performance
\item Energy feedback
\item Charge feedback
\item Specification of bunch train format    
\item Beam loading compensation      
\item Energy measurement     
\item Energy spread measurement      
\item Emittance measurement (3 screens)      
\item Emittance measurement (quad scans)     
\item Matching of Twiss parameters into booster septum       
\item Beam stacking  
\item Beam transmission optimization 
\item TL quad centering      
\item Integration of safety devices/interlocks       
\end{itemize}

\item Booster
\begin{itemize}
\item Diagnostics calibration       
\item Orbit correction       
\item Tune measurement system
\item Energy measurement     
\item Momentum compaction measurement
\item Emittance measurements 
\item Beam stacking  
\item Extraction optimization
\item Ramp optimization      
\item LOCO-type machine characterization     
\item MIA in transport line -- booster acceptance testing
\item Orbit feedback 
\item Synchrotron Radiation diagnostics      
\item Bunch cleaning system  
\item TL quad centering      
\item Integration of safety devices/interlocks       
\end{itemize} 

\item SR

  In addition to what has been already specified by Accelerator Physics:

\begin{itemize}
\item Closed bump optimization: A and t
\item Simultaneous measurements of injected/stored beam orbits
\item Measurement of injection efficiency
\end{itemize}

\end{itemize}


\subsection{Terminology for High Level Applications}

The naming convension and terminology should follow the definitions of
project nomenclature standard:

\begin{itemize}
\item National Synchrotron Light Source II - Nomenclature Standard~\cite{lt_2009_nomenclature}
\item National Synchrotron Light Source II - Accelerator Systems
Requirements Document, Storage Ring Physics Nomenclature Standard~\cite{lt_2008_nomenclature}
\end{itemize}

A set of commonly used words are explained in the following:

\begin{enumerate}
\item \emph{Mode\index{mode}}
is used for separating different machine settings. As an example, there
could be ``production mode'', ``accelerator physics beam study mode'',
``short bunch mode'', ``low current mode''. With this separation, all
the other settings can be same or different for two modes.

\item \emph{Group}\index{group} represents a set of elements when they are
  sharing similar position, symmetry, purpose, connections or user's
  preferences. For example, we can assign all sextupoles with a group name
  \code{sextupole} and all magnets on the second girder in each cell a
  group name \code{girder2}. From lattice point of view, we can have a
  group name \code{qh1} for all quadrupoles with this symmetry. Each
  element or magnet can belong to one or more groups.  For consistancy,
  the element belongs to the group which has only himself and the group
  name is same as its element name (the element name is guaranteed
  unique).

  We can have some predefined group names, and they will be commonly used
  for their type or symmetry, e.g. \code{quadrupole}, \code{sh1}. The
  pre-defined group name should be discussed carefully, and stored in a
  relational database, \code{IRMIS} for example. Users can also define
  their own group name which should not overwrite any system defined group
  names.

  The suggested candidates of group name are:
  \begin{itemize}
  \item Magnet with same power supply or lattice symmetry.
  \item \code{bpm}, \code{corrector}, \code{quadrupole}, \code{sextupole},
    \code{skewquadrupole}, ...
  \item Specific purpose: \code{bba}, \code{orbit}, \code{tune},
    \code{chromaticity}
  \item User defined: ``Sam's test BPM'', ``Weiming's Toy'', ...
  \end{itemize}

  \index{wildcard} When searching for a group, the name matching should
  support a subset of regular expression (need more details on ``subset'',
  how small/large is this set). One choice is the BASH wildcards:
  \begin{itemize}
  \item \strong{*}, zero or more characters
  \item \strong{?}, exactly one character
  \item \strong{[abcde]}, exactly one character listed
  \item \strong{[a-e]}, exactly one character in the given range
  \item \strong{[!abcde]}, any character that is not listed
  \item \strong{[!a-e]}, any character that is not in the given range
  \item \strong{\{debian,linux\}}, exactly one entire word in the options
    given
  \end{itemize}
\item \emph{Sequence}\index{sequence} We can also use sequence to identify
  one element, usually BPM or corrector. For the convenience purpose when
  looping over BPM or correctors one after the other along the ring, we
  can use number as its order, instead of their names. Suggested sequence
  could be a pair [\emph{cell}, \emph{index}], and \emph{cell} is the cell
  number following the name convention as below, which is an integer
  between 1 and 30 according to the NSLS-II
  nomenclature~\cite{lt_2008_nomenclature,lt_2009_nomenclature}. The index
  is the order (according to s-location) in that cell, and index starts
  from 0 to follow some language conversion such as Python/C/C++. A
  definition similar to \code{MML (Matlab Middle Layer)} can be
  atopted. This part should be discuss carefully to avoid ambiguity.
  \index{coordinate} \index{original point}
\item \emph{Coordinate definition}, we always use \code{x}, \code{y} and
  \code{s} specify the horizontal, vertical and longitudinal plane. The
  $s=0$ is defined as the injection point (in Cell 30).
\item \emph{Array Data Arrangement\index{array}} Whenever the value is an
  array, sort it in the beam direction, for example, in increasing order
  of $s$ location. This may be confusing for the injection cell, where
  $s=0$ does not aligned with the begin/end point of a cell, but in the
  middle.

  A policy to determine who is the first element should be
  discussed. ($s=0$ location)

\item \emph{Control System} A dictionary for common control system
  terminologies are in \ref{sec:cs:terminology}.
\end{enumerate}



\subsection{Acronym and API Prefix}

We recommend to use full word instead of acronym, but for the most
common ones, acronym makes life easier. The following list serves as a
guideline for API prefix but exceptions do exist.
\begin{itemize}
\item \strong{meas} is for measurement routines. They may perturb the beam, and affect users.
\item \strong{get} is either read history or the output of online instrument.
\item \strong{set} will change the settings of an online instrument. The value will be gone after next injection(non-topoff)
\item \strong{save} operates on file, read machine to file/DB. (set operates on real machine, on a smaller scale, single element/group). The new value will take effect in next injection/run. 
\item \strong{load} operates on files/DB and set to memory/machine.
\item \strong{calc} is for routines doing calculation and analysis. This is calculation only, does not perturb the beam.
% @c \item \strong{anal} is for routines more complicated than \code{calc}, the results are a set of results.
\item \strong{enable/disable} makes element online/offline
% @c \item \strong{download/upload} works with remote central managed info, like golden orbit, response matrix. 
\end{itemize}

There are exceptions that a few APIs have prefix not mentioned above
(see \cite{shen_hla_apis} for a complete list).

BPM(beam position monitor), RF(radio frequency), SOFB/FOFB(slow/fast
orbit feedback), bba(beam based alignment), chrom(chromaticity),
sp(setpoint), rb(readback) are common acronyms.


\section{HLA Scripts and Applications}



\chapter{Specification for Accelerator Physics Toolkit}

\section{Orbit}

\begin{itemize}
    \item Orbit
    \begin{enumerate}
    \item Closed orbit display

        Description: 
        
        Repetition rate: .5Hz
        
        Related APIs: \code{getOrbit}, \code{getLocation}
        
        Data structure: One dimension array, time stamp, BPM status
        (Bad or Good), severity.

        Other requirement: Bad BPM identification should be done in
        other application. Data synchronization to be done in low
        level server part.

    \item Orbit feedback status

        Description: 
        
        Repetition rate: .1Hz
        
        Related APIs: \code{getFofbStatus}
        
        Data structure: On/Off status only? To be defined.

        Other requirement: \strong{TBD}. Historic plotting can be done using
        strip tool or CSS (Control System Studio).

    \item Orbit stability, especially drift and variation

        Repetition rate: 
        
        Related APIs: 
        
        Data structure:

        Other requirement:

    \item Turn by turn BPM reading vistualization if available

        Description: 
        
        Repetition rate: .01Hz
        
        Related APIs: \code{getTbtBpmBuffer}
        
        Data structure: One dimension array, time stamp, severity.

        Other requirement: \strong{TBD}. 

    \end{enumerate}

    \item Tunes

        Description: 
        
        Repetition rate: 1Hz
        
        Related APIs: \code{getTune}
        
        Data structure: [tunex, tuney], time stamp, severity.

        Other requirement: \strong{TBD}. Hostoric plotting can be done using
        strip tool or CSS (Control System Studio).

    \item Magnets

    Description: The status presents all status, such as ON/OFF, set
                 point, read back, temperature and so on. This is for
                 all magnets and their power supply including main
                 dipole, quadrupole, sextupole, correctors. Gives
                 warnings when they differs more than threshold, or the
                 settings is outside of specified range.

    Repetition rate: 
        
    Related APIs: 
  
    Data structure: 

    Other requirement: \strong{TBD}. 

    \item Vacuum status.

    Description: The status presents all status, such as Online/Offline, set
                 point, read back, temperature, pressure and so on for
                 all vaccum devices. Gives warnings for example when
                 vacuum pressure is over threshold. 

    Repetition rate: 
        
    Related APIs: 
  
    Data structure: 

    Other requirement: \strong{TBD}. 

\end{itemize}


\appendix
\chapter{Reference}

\begin{thebibliography}{99}
\bibitem{bengtsson_2008_nsls-ii} J. Bengtsson, B. Dalesio, T. Shaftan, T. Tanabe, \emph{NSLS-II:
Model Based Control - A Use Case Approach}, Tech-note 51, Oct 2008 
\bibitem{willeke_2009_assumptions} F. Willeke, \emph{Assumptions on NSLS-II Accelerator Commissioning}, November 22, 2009
\bibitem{willeke_2010_path} F. Willeke, \emph{The Path to Accelerator Commissioning}, talk
on ASD Project Meeting, Jan 2010
\bibitem{krinsky_2010_nsls-ii} S. Krinsky, \emph{NSLS-II Storage Ring Commissioning}, NSLS-II ASD Retreat, May 13, 2010.
\bibitem{lt_2009_nomenclature} \emph{National Synchrotron Light Source II - Nomenclature Standard},
LT-ENG-RSI-STD-002, Jan 21, 2009, Rev 2
\bibitem{lt_2008_nomenclature} \emph{National Synchrotron Light Source II - Accelerator Systems
Requirements Document, Storage Ring Physics Nomenclature Standard},
RSI Document 1.3.4-001, Feb 17, 2008, Rev 1
\bibitem{shen_cbd} G.~Shen, Y.~Hu, B. Dalesio, \emph{Circular Buffer Diagnostic}
\bibitem{shen_hla_apis} G.~Shen, L.~Yang, \emph{High level applications - APIs}
\bibitem{python} Python, \url{http://www.python.org/}
\bibitem{ipython} iPython, \url{http://ipython.scipy.org/moin/}
\bibitem{matplotlib} matploblit, \url{http://matplotlib.sourceforge.net/}
\bibitem{scipy} SciPy, \url{http://numpy.scipy.org/}
\end{thebibliography}

%@node Index
%@unnumbered Index
%\chapter{Index}
\pagestyle{index}
\printindex

@node Function Index, Variable Index
@unnumbered Function Index

%@printindex fn



@node Notes
@unnumbered Note

\begin{enumerate}
\item How long to fix (or by pass) an unpredicted situation(or more worse, a bug?) in control room, in a two hours shift ?
\item Server side log ?
\item How to keep the server(manager) most updated
\end{enumerate}

@node Coding Style
@heading Coding Style

\begin{enumerate}
\item Use @code{doxygen} for @code{C/C++} ?
\item write \verb+__doc__+ in Python ?
\item Use @code{sphinx} for Python ?
\item 4 spaces per indentation level.
\item never mix tabs and spaces. Use space to replace tab
\item limit all lines to a maximum of 79 characters.
\item document well and in detail.
\end{enumerate}

@node Summary of Meetings
@heading Summary of Meetings
@c unnumbered Summary of Meetings

\begin{enumerate}
\item @strong{2010/04/23, Bob, Choi, Don, Guobao and Lingyun}
      \begin{itemize}%[\bfseries\textenddash]
      \item Guobao showed implementations of two server, a use case of global
     orbit is presented. Exposed some details to us, and helpful to
     implement a CAPI, and a guide for defining the SAPI.
     \item Should we have a server side log ? like Apache log in linux ?
   \item We should be able to define "a set of magnets" and save it, leave
     comments and username. So in the future, we can recall this set, and monitor the data
   \item We will have a more detailed description of CAPI, for Guobao and Don
     to define the SAPI.
   \item We will have an example of "creating local orbit bump" based on this
     architecture, and show them in AP group, and have more discussions.
   \item On the server side, we agreed to have more discussions on what kind of functions can be provided to CAPI, and how to use them. Take the "creating local orbit bump" as an example to move toward the CAPI requirement. After several discussions, two groups from two sides can merge together with a complete set of CAPI/SAPI.
   \end{itemize}
\end{enumerate}

%@node Tools/Coding/Documentation
%@heading Tools/Coding/Documentation

\begin{itemize}
\item C/C++ and Python would be the main language for HLAs development and data process.
\item Python + iPython + matplotlib + numpy are preferred for
   *Interactive Environment*. For people who prefer MATLAB, we also provide MATLAB Middle Layer Toolkit (MMLT) by Greg Portman at Lawrence Berkeley National Laboratory as an option.
\item The HLAs can be written in Python, in this case we prefer PyQt as GUI
   library. This makes the sharing of API between interactive environment
   and HLAs easy. However, we can also use C bindings of EPICS, then
   Qt/C++ as GUI library. For applications use only low level API
   (operates on channels directly) this can also be a recommended choice.
 \item Other monitoring applications can be constructed from MEDM or CSS.
 \item A central repository will be set up, and code review (or other form of
   discussion the code we have written) will also be arranged.
 \item A running virtual accelerator is already running, and use for testing
   the HLAs.
\end{itemize}

\section{Terminology Definition for Control System\label{sec:cs:terminology}}

\begin{enumerate}
\item EPICS
\index{EPICS}
\item Channel
\index{Channel}
\item Record
\index{Record}
\item PV (Process Variable)
\index{PV}
\index{Process Variable}
\item CA (Channel Access)
\index{CA}
\index{Channel Access}
\end{enumerate}

\section{Revision History}

\begin{itemize}
\item  2010-10-14, ASAC review
\item  2010-06-24, discuss with group leaders and ASD head.
\item  2010-06-14, Guobao Shen, rev 1
\item  2010-06-08, Lingyun Yang, init
\end{itemize}


\end{document}
